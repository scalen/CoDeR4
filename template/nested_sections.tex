\newcounter{nestingdepth}
\setcounter{nestingdepth}{0}
\newenvironment{nestedsection}[2]{
	\ifnum\value{nestingdepth}=0
		\chapter{#1}
	\else
		\ifnum\value{nestingdepth}=1
			\section{#1}
		\else
			\ifnum\value{nestingdepth}=2
				\subsection{#1}
			\else
				\ifnum\value{nestingdepth}=3
					\subsubsection{#1}
				\else
					\ifnum\value{nestingdepth}=4
						\paragraph{#1}
					\else
						\PackageError{nestedsections}{Maximum nesting level exceeded!}{uh oh!}
					\fi
				\fi
			\fi
		\fi
	\fi
	\addtocounter{nestingdepth}{1}
	\label{sec:#2}
}{\addtocounter{nestingdepth}{-1}}

\newenvironment{untrackednestedsection*}[2]{
	\ifnum\value{nestingdepth}=0
		\chapter*{#1}\def\sectiontype{chapter}
	\else
		\ifnum\value{nestingdepth}=1
			\section*{#1}\def\sectiontype{section}
		\else
			\ifnum\value{nestingdepth}=2
				\subsection*{#1}\def\sectiontype{subsection}
			\else
				\ifnum\value{nestingdepth}=3
					\subsubsection*{#1}\def\sectiontype{subsubsection}
				\else
					\ifnum\value{nestingdepth}=4
						\paragraph*{#1}\def\sectiontype{paragraph}
					\else
						\PackageError{nestedsections}{Maximum nesting level exceeded!}{uh oh!}
					\fi
				\fi
			\fi
		\fi
	\fi
	\addtocounter{nestingdepth}{1}
}{\addtocounter{nestingdepth}{-1}}

\newcommand\addnestedcontentsline[3]{
	\ifnum\value{nestingdepth}=1
		\label{#3}\addcontentsline{#1}{chapter}{#2}
	\else
		\ifnum\value{nestingdepth}=2
			\label{#3}\addcontentsline{#1}{section}{#2}
		\else
			\ifnum\value{nestingdepth}=3
				\label{#3}\addcontentsline{#1}{subsection}{#2}
			\else
				\ifnum\value{nestingdepth}=4
					\label{#3}\addcontentsline{#1}{subsubsection}{#2}
				\else
					\ifnum\value{nestingdepth}=5
						\label{#3}\addcontentsline{#1}{paragraph}{#2}
					\else
						\PackageError{nestedsections}{Maximum nesting level exceeded!}{uh oh!}
					\fi
				\fi
			\fi
		\fi
	\fi
}

\newenvironment{nestedsection*}[2]{
	\begin{untrackednestedsection*}{#1}{#2}
		\addnestedcontentsline{toc}{#1}{#2}
}{\end{untrackednestedsection*}}

\newenvironment{nestedappendix}[2]{
	\ifnum\value{nestingdepth}=0
		\chapter{#1}
	\else
		\ifnum\value{nestingdepth}=1
			\section{#1}
		\else
			\ifnum\value{nestingdepth}=2
				\subsection{#1}
			\else
				\ifnum\value{nestingdepth}=3
					\subsubsection{#1}
				\else
					\ifnum\value{nestingdepth}=4
						\paragraph{#1}
					\else
						\PackageError{nestedsections}{Maximum nesting level exceeded!}{uh oh!}
					\fi
				\fi
			\fi
		\fi
	\fi
	\addtocounter{nestingdepth}{1}
	\label{app:#2}
}{\addtocounter{nestingdepth}{-1}}